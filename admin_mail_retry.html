<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= include('styles'); ?>
  </head>
  <body>
    <div class="container">
      <h1>再送キュー</h1>
      <? if (organizationName) { ?>
        <p class="muted"><?!= organizationName ?></p>
      <? } ?>

      <nav class="admin-nav">
        <a class="link" href="?action=admin_dashboard">ダッシュボード</a>
        <a class="link" href="?action=admin">会員一覧</a>
        <a class="link" href="?action=admin_mail_log">メール履歴</a>
        <a class="link" href="?action=admin_action_log">操作ログ</a>
        <a class="link" href="?action=admin_change_log">変更履歴</a>
        <a class="link" href="?action=admin_error_log">エラーログ</a>
        <a class="link" href="?action=admin_mail_retry">再送キュー</a>
        <a class="link" href="?action=admin_templates">テンプレート</a>
        <a class="link" href="?action=admin_template_log">テンプレ履歴</a>
      </nav>

      <form method="get" class="toolbar">
        <input type="hidden" name="action" value="admin_mail_retry" />
        <input type="text" name="q" value="<?!= query ?>" placeholder="宛先・件名で検索" />
        <select name="page_size">
          <option value="25" <?!= pageSize === 25 ? 'selected' : '' ?>>25件</option>
          <option value="50" <?!= pageSize === 50 ? 'selected' : '' ?>>50件</option>
          <option value="100" <?!= pageSize === 100 ? 'selected' : '' ?>>100件</option>
        </select>
        <button type="submit">検索</button>
      </form>

      <p class="hint">表示件数: <?!= pageSize ?>件 / 全<?!= total ?>件</p>

      <table class="table">
        <thead>
          <tr>
            <th>作成日時</th>
            <th>種類</th>
            <th>宛先</th>
            <th>件名</th>
            <th>状態</th>
            <th>エラー</th>
            <th>再送</th>
          </tr>
        </thead>
        <tbody>
          <? if (retries.length === 0) { ?>
            <tr>
              <td colspan="7">再送対象がありません。</td>
            </tr>
          <? } else { ?>
            <? retries.forEach(function(item) { ?>
              <tr>
                <td><?!= item.createdAt ?></td>
                <td><?!= item.type ?></td>
                <td><?!= item.recipient ?></td>
                <td><?!= item.subject ?></td>
                <td><?!= item.status ?></td>
                <td><?!= item.lastError ?></td>
                <td>
                  <form method="post" class="inline-form">
                    <input type="hidden" name="action" value="admin_retry_send" />
                    <input type="hidden" name="row_index" value="<?!= item.rowIndex ?>" />
                    <button type="submit">再送</button>
                  </form>
                </td>
              </tr>
            <? }); ?>
          <? } ?>
        </tbody>
      </table>

      <div class="pager">
        <? if (page > 1) { ?>
          <a href="?action=admin_mail_retry&q=<?!= encodeURIComponent(query) ?>&page_size=<?!= pageSize ?>&page=<?!= page - 1 ?>">前へ</a>
        <? } ?>
        <? if (page * pageSize < total) { ?>
          <a href="?action=admin_mail_retry&q=<?!= encodeURIComponent(query) ?>&page_size=<?!= pageSize ?>&page=<?!= page + 1 ?>">次へ</a>
        <? } ?>
      </div>
    </div>
  </body>
</html>
